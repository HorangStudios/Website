<!DOCTYPE html>
<html lang="en">

<head>
	<title>HorangHill</title>
	<link rel="stylesheet" href="../../css/new.css">
	<link rel="icon" type="image/x-icon" href="logo.png">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://kit.fontawesome.com/970a0290cd.js" crossorigin="anonymous"></script>
</head>

<body>
	<header id="header">
		<div id="form">
			<input id="title" readonly style="resize: none;"></input>
			<h3 id="dev"></h3>
			<textarea id="desc" readonly style="resize: none;"></textarea>
			<br>
			<button id="play" style="width: calc(100% - 99px); display: inline-block;"><i class="fa-solid fa-play"></i>
				Play</button>
			<button style="display: inline-block; width: fit-content;" onclick="contextMenu()"><i
					class="fa-solid fa-bars"></i></button>

			<div id="contextMenu" style="display: none; text-align: center;">
				<input type="file" accept=".hhls" id="file-input" onchange="importScene()" placeholder="HHLS File"
					required style="display: none;"></input>
				<button id="edit" style="display: none; width: fit-content;"
					onclick="document.getElementById('file-input').click()"><i class="fa-solid fa-upload"></i></button>

				<button id="download" style="display: none; width: fit-content;" onclick="downloadHHLS()"><i
						class="fa-solid fa-download"></i></button>

				<button style="display: inline-block; width: fit-content;" onclick="shareGame()"><i
						class="fa-solid fa-share"></i></button>
			</div>
		</div>
	</header>

	<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-database.js"></script>
	<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-auth.js"></script>
	<script>
		// Initialize Firebase
		const firebaseConfig = {
			apiKey: "AIzaSyDE-mQcJoquJxLrHAcS1kZbpjUbHYQmzsE",
			authDomain: "horanghill.firebaseapp.com",
			databaseURL: "https://horanghill-default-rtdb.firebaseio.com",
			projectId: "horanghill",
			storageBucket: "horanghill.appspot.com",
			messagingSenderId: "710235265347",
			appId: "1:710235265347:web:37fb53fe0bb9c4ecdab7f6",
			measurementId: "G-S1JMDFPGL0"
		};
		firebase.initializeApp(firebaseConfig);
		var database = firebase.database();

		const id = new URLSearchParams(window.location.search).get('id');

		const ref = firebase.database().ref(`games/${id}`);
		var item
		ref.once('value', snapshot => {
			item = snapshot.val();

			//load game details
			document.getElementById('header').style.backgroundImage = "url(" + item.thumbnail + ")";
			document.getElementById('title').value = item.title;
			document.getElementById('desc').value = item.desc;
			document.getElementById('dev').innerText = "By " + item.createdBy;
			document.getElementById('play').onclick = function () {
				window.location.href = ("http://horangstudios.github.io/LigmaForge/player/?id=" + id + "&online=true")
			};

			function setHeight(fieldId) {
				document.getElementById(fieldId).style.height = document.getElementById(fieldId).scrollHeight + 'px';
			}
			setHeight('desc');
			setHeight('title');

			//if user is game owner
			if (item.uid == firebase.auth().currentUser.uid) {
				document.getElementById('edit').style.display = "inline-block"
				document.getElementById('download').style.display = "inline-block"

				document.getElementById('title').removeAttribute("readonly");
				document.getElementById('desc').removeAttribute("readonly");

				document.getElementById('title').style.resize = "vertical";
				document.getElementById('desc').style.resize = "vertical";

				document.getElementById('title').addEventListener("input", function () {
					ref.update({
						title: document.getElementById('title').value,
					})
				});

				document.getElementById('desc').addEventListener("input", function () {
					ref.update({
						desc: document.getElementById('desc').value,
					})
				});
			}
		});

		function downloadHHLS() {
			// Convert scene to JSON format
			const json = JSON.stringify(item.hhls, null, 2);

			// Create a new blob with the JSON data and custom file extension
			const blob = new Blob([json], { type: "application/json" });
			const fileName = `${item.title}.HHLS`;

			// Use the browser's native save dialog to save the file
			const url = URL.createObjectURL(blob);
			const link = document.createElement("a");
			link.href = url;
			link.download = fileName;
			link.click();
		}

		function importScene() {
			if (item.uid == firebase.auth().currentUser.uid) {
				var input = document.getElementById("file-input");
				const file = input.files[0];

				const reader = new FileReader();
				reader.onload = function (event) {
					const contents = event.target.result;
					const json = JSON.parse(contents);

					ref.update({
						hhls: json,
					})
				};

				reader.readAsText(file);
			}
		}

		function shareGame() {
			const shareData = {
				title: "Try out " + item.title + " on Horanghill",
				text: item.desc,
				url: window.location.href,
			};

			try {
				navigator.share(shareData);
			} catch (err) {
				console.log(`Error: ${err}`);
			}
		}

		function contextMenu() {
			var x = document.getElementById("contextMenu");
			if (x.style.display == "none") {
				x.style.display = "block";
			} else {
				x.style.display = "none";
			}
		}
	</script>
</body>

</html>