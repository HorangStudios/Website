<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset='utf-8'>
	<meta http-equiv='X-UA-Compatible' content='IE=edge'>
	<meta name='viewport' content='width=device-width, initial-scale=1'>

	<title>HorangHill</title>

	<link rel="icon" type="image/x-icon" href="../css/HorangHill.png">
	<link rel="stylesheet" href="../css/home.css">

	<script src="https://kit.fontawesome.com/970a0290cd.js" crossorigin="anonymous"></script>
	<script src="https://www.google.com/recaptcha/api.js" async defer></script>
	<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-database.js"></script>
	<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-auth.js"></script>

	<script src="../js/firebaseConfig.js"></script>
</head>

<body>
	<div class="g-recaptcha" data-sitekey="6LejRf8rAAAAAHgkRlKWd_M6P9IUDp5JJCc0ttCB" data-size="invisible"></div>
	<div id="sidebar">
		<div class="sidebar-contain">
			<h1 id="gamename">
				<i class="fa-solid fa-spinner fa-spin"></i> Fetching game data...
			</h1>
		</div>
	</div>
	<div id="main" class="tabcontent">
		<div id="form" style="display: none;">
			<center>
				This site is protected by reCAPTCHA and the Google
				<a href="https://policies.google.com/privacy">Privacy Policy</a> and
				<a href="https://policies.google.com/terms">Terms of Service</a> apply.
				<br>
			</center>

			<input type="file" accept=".hhls" id="file-input" onchange="importScene()" style="display: none;">
			<input type="file" accept="image/*" id="thumbnail" onchange="importIMG()" style="display: none;">

			<input id="title" style="cursor: text;"><br>
			<textarea id="desc"></textarea><br>

			<button id="edit" style="width: fit-content;" onclick="document.getElementById('file-input').click()">
				<i class="fa-solid fa-upload"></i> <span id="uploadUpdate">Upload update</span>
			</button>
			<button id="edit" style="width: fit-content;" onclick="document.getElementById('thumbnail').click()">
				<i class="fa-solid fa-upload"></i> <span id="thumbnail-label">Upload thumbnail</span>
			</button>
			<button id="download" style="width: fit-content;" onclick="downloadHHLS()">
				<i class="fa-solid fa-download"></i> Download game
			</button>
		</div>
	</div>

	<script defer>
		var database = firebase.database();
		var id = new URLSearchParams(window.location.search).get('id');
		var ref = firebase.database().ref(`games/${id}`);
		var item

		ref.once('value', snapshot => {
			item = snapshot.val();
			document.getElementById('gamename').innerText = item.title;
			document.getElementById('title').value = item.title;
			document.getElementById('desc').value = item.desc;

			if (item.uid == firebase.auth().currentUser.uid) {
				document.getElementById('form').style.display = "block";

				document.getElementById('title').addEventListener("change", function () {
					grecaptcha.execute().then(() => {
						if (!grecaptcha.getResponse()) return;
						ref.update({
							title: document.getElementById('title').value,
						})
					})
				});

				document.getElementById('desc').addEventListener("change", function () {
					grecaptcha.execute().then(() => {
						if (!grecaptcha.getResponse()) return;
						ref.update({
							desc: document.getElementById('desc').value,
						})
					})
				});
			}
		});

		function downloadHHLS() {
			const json = JSON.stringify(item.hhls, null, 2);
			const blob = new Blob([json], { type: "application/json" });
			const fileName = `${item.title}.HHLS`;
			const url = URL.createObjectURL(blob);
			const link = document.createElement("a");

			link.href = url;
			link.download = fileName;
			link.click();
		}

		function importScene() {
			if (item.uid == firebase.auth().currentUser.uid) {
				var input = document.getElementById("file-input");
				var label = document.getElementById("uploadUpdate");
				const file = input.files[0];

				const reader = new FileReader();
				reader.onload = function (event) {
					const contents = event.target.result;
					const json = JSON.parse(contents);

					grecaptcha.execute().then(() => {
						if (!grecaptcha.getResponse()) return;
						firebase.database().ref(`storage/${item.hhls}/file`).set(json);
						label.innerText = 'Updated!'
					})
				};

				reader.readAsText(file);
			}
		}

		function importIMG() {
			var input = document.getElementById("thumbnail");
			var label = document.getElementById("thumbnail-label");
			const file = input.files[0];

			const reader = new FileReader();
			reader.onload = function (event) {
				grecaptcha.execute().then(() => {
					if (!grecaptcha.getResponse()) return;
					ref.update({
						thumbnail: reader.result
					})
					label.innerText = 'Thumbnail Updated!'
				})
			};

			reader.readAsDataURL(file);
		}
	</script>
</body>

</html>